<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Summer — Journal</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="journal-body">
  <!-- Background video -->
  <video
    id="bgvid"
    class="bg-video"
    autoplay
    muted
    loop
    playsinline
    preload="auto"
    aria-hidden="true"
    poster="assets/background_2_poster.jpg"
  >
    <source src="assets/background_2.mp4" type="video/mp4" />
  </video>
  <div class="bg-scrim" aria-hidden="true"></div>

  <header class="site-header journal-headerbar">
    <nav class="nav">
      <a href="index.html" class="nav-link">← Home</a>
    </nav>
  </header>

  <main class="journal-wrap">
    <div class="journal-top">
      <h1 class="journal-title">Journal</h1>
      <span id="count" class="journal-count"></span>
    </div>

    <div class="journal-controls glass">
      <input id="search" type="search" class="journal-search" placeholder="Search title, tags, or summary…" />
      <span id="status" class="journal-status">Loading posts…</span>
    </div>

    <section id="posts" class="journal-grid" aria-live="polite"></section>
  </main>

  <script>
    const postsEl  = document.getElementById('posts');
    const countEl  = document.getElementById('count');
    const statusEl = document.getElementById('status');
    const searchEl = document.getElementById('search');
    let ALL = [];

    const CANDIDATES = ['data/journal.json', '/data/journal.json'];

    (async function load(){
      for (const url of CANDIDATES) {
        try {
          const r = await fetch(url, {cache:'no-store'});
          if (!r.ok) continue;
          const data = await r.json();
          if (Array.isArray(data)) {
            ALL = data.filter(x => x && typeof x === 'object')
                      .sort((a,b)=> new Date(b.date||0) - new Date(a.date||0));
            statusEl.textContent = '';
            render(ALL);
            hookSearch();
            return;
          }
        } catch(e) {}
      }
      statusEl.textContent = "Couldn't load data/journal.json — showing a demo post.";
      ALL = [{
        title: "Demo post — setup complete",
        date: new Date().toISOString().slice(0,10),
        summary: "Your journal is wired. Add posts in data/journal.json.",
        tags: ["setup","journal"],
        url: "index.html"
      }];
      render(ALL);
      hookSearch();
    })();

    function render(list){
      postsEl.innerHTML = '';
      countEl.textContent = `(${list.length})`;
      if (!list.length){ statusEl.textContent = 'No posts yet.'; return; }
      list.forEach(p => {
        const title = safe(p.title) || 'Untitled';
        const date  = p.date ? new Date(p.date).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}) : '';
        const sum   = safe(p.summary || '');
        const url   = p.url || '#';
        const tags  = Array.isArray(p.tags) ? p.tags : [];
        const card = document.createElement('article');
        card.className = 'journal-card glass';
        card.innerHTML = `
          <a class="post-title" href="${url}">${title}</a>
          <div class="post-meta">${date}</div>
          ${sum ? `<p class="post-summary">${sum}</p>` : ``}
          ${tags.length ? `<div class="post-tags">${tags.map(t => `<span class="pill">${safe(t)}</span>`).join('')}</div>` : ``}
        `;
        postsEl.appendChild(card);
      });
    }

    function hookSearch(){
      searchEl.addEventListener('input', e => {
        const q = e.target.value.trim().toLowerCase();
        if (!q) return render(ALL);
        const f = ALL.filter(p => [
          p.title||'',
          p.summary||'',
          ...(Array.isArray(p.tags) ? p.tags : [])
        ].join(' ').toLowerCase().includes(q));
        render(f);
      });
    }

    function safe(s){
      return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Accessibility: respect reduced motion
    const vid = document.getElementById('bgvid');
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)');
    if (prefersReduced.matches && vid) { vid.removeAttribute('autoplay'); vid.pause?.(); }
  </script>
</body>
</html>
